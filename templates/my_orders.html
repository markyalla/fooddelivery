{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">My Orders</h2>
    {% if orders %}
    <table class="table">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Restaurant</th>
                <th>Driver</th>
                <th>Delivery Type</th>
                <th>Vehicle License</th>
                <th>Vehicle Type</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.total_amount }}</td>
                <td>{{ order.status }}</td>
                <td>{{ order.created_at }}</td>
                <td>
                    {% if order.restaurant %}
                        {{ order.restaurant.name }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    {% if order.deliveries and order.deliveries[0].driver %}
                        {{ order.deliveries[0].driver_name|default('No driver assigned') }}
                    {% else %}
                        No driver assigned
                    {% endif %}
                </td>
                <td>
                    {% if order.deliveries %}
                        {{ order.deliveries[0].delivery_type|default('N/A') }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    {% if order.deliveries and order.deliveries[0].license_number %}
                        {{ order.deliveries[0].license_number|default('N/A') }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    {% if order.deliveries and order.deliveries[0].vehicle_name %}
                        {{ order.deliveries[0].vehicle_name|default('N/A') }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#orderModal{{ order.id }}">
                        View Details
                    </button>
                    {% if order.deliveries and order.deliveries[0].delivery_status|lower in ['assigned', 'picked_up', 'in_transit'] %}
                        <button class="btn btn-primary track-btn" 
                                data-id="{{ order.deliveries[0].id|default('N/A') }}" 
                                data-order-id="{{ order.id }}" 
                                data-customer-lat="{{ order.deliveries[0].user_latitude|default('') }}" 
                                data-customer-lng="{{ order.deliveries[0].user_longitude|default('') }}"
                                data-driver-lat="{{ order.deliveries[0].vehicle_latitude|default('') }}"
                                data-driver-lng="{{ order.deliveries[0].vehicle_longitude|default('') }}"
                                data-address="{{ order.deliveries[0].delivery_address|default('N/A') }}"
                                data-driver-name="{{ order.deliveries[0].driver_name|default('N/A') }}"
                                data-vehicle-name="{{ order.deliveries[0].vehicle_name|default('N/A') }}"
                                data-license-number="{{ order.deliveries[0].license_number|default('N/A') }}"
                                data-status="{{ order.deliveries[0].delivery_status|lower }}"
                                data-bs-toggle="modal" 
                                data-bs-target="#trackModal{{ order.id }}">
                            Track Delivery
                        </button>
                    {% else %}
                        <span>No tracking available (Status: {{ order.deliveries[0].delivery_status|default('N/A')|title }})</span>
                    {% endif %}
                </td>
            </tr>

            <!-- Modal for Order Details -->
            <div class="modal fade" id="orderModal{{ order.id }}" tabindex="-1" aria-labelledby="orderModalLabel{{ order.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="orderModalLabel{{ order.id }}">Order #{{ order.id }} Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Restaurant:</h6>
                            <p>{{ order.restaurant.name if order.restaurant else 'N/A' }}</p>
                            <h6>Delivery Address:</h6>
                            <p>{{ order.deliveries[0].delivery_address if order.deliveries else 'N/A' }}</p>
                            <h6>Driver Information:</h6>
                            {% if order.deliveries and order.deliveries[0].driver %}
                                <p>Name: {{ order.deliveries[0].driver_name|default('N/A') }}</p>
                                <p>Delivery Type: {{ order.deliveries[0].delivery_type|default('N/A') }}</p>
                                <p>Vehicle License: {{ order.deliveries[0].license_number|default('N/A') }}</p>
                                <p>Vehicle Type: {{ order.deliveries[0].vehicle_name|default('N/A') }}</p>
                            {% else %}
                                <p>No driver assigned</p>
                            {% endif %}
                            <h6>Items Ordered:</h6>
                            <ul>
                                {% for item_order in order.items %}
                                    <li>
                                        {% if item_order.food_item %}
                                            {{ item_order.food_item.name }} (Quantity: {{ item_order.quantity }}) - ${{ item_order.food_item.price * item_order.quantity }}
                                        {% else %}
                                            Item Not Found
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                            <h6>Payment Information:</h6>
                            {% if payments_by_order and payments_by_order[order.id] %}
                                {% set payment = payments_by_order[order.id] %}
                                <p>Transaction ID: {{ payment.transaction_id }}</p>
                                <p>Phone Number: {{ payment.phone_number }}</p>
                                <p>Payment Method: {{ payment.payment_method }}</p>
                            {% else %}
                                <p>No payment information available.</p>
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Modal for Live Tracking -->
            <div class="modal fade" id="trackModal{{ order.id }}" tabindex="-1" aria-labelledby="trackModalLabel{{ order.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="trackModalLabel{{ order.id }}">Track Delivery for Order #{{ order.id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>Driver Information:</h6>
                                    <p><strong>Name:</strong> {{ order.deliveries[0].driver_name if order.deliveries and order.deliveries[0].driver_name else 'No driver assigned' }}</p>
                                    <p><strong>Vehicle:</strong> {{ order.deliveries[0].vehicle_name if order.deliveries and order.deliveries[0].vehicle_name else 'N/A' }}</p>
                                    <p><strong>License:</strong> {{ order.deliveries[0].license_number if order.deliveries and order.deliveries[0].license_number else 'N/A' }}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Delivery Information:</h6>
                                    <p><strong>Address:</strong> {{ order.deliveries[0].delivery_address if order.deliveries else 'N/A' }}</p>
                                    <p><strong>Distance:</strong> <span id="distance{{ order.id }}">Calculating...</span></p>
                                    <p><strong>Status:</strong> <span id="trackingStatus{{ order.id }}" class="badge bg-secondary">Initializing...</span></p>
                                </div>
                            </div>
                            <div id="coordinateInfo{{ order.id }}" style="font-size: 12px; color: #666; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                <strong>Location Info:</strong><br>
                                <span id="customerCoords{{ order.id }}">Your Location: Loading...</span><br>
                                <span id="driverCoords{{ order.id }}">Driver Location: Loading...</span>
                            </div>
                            <div id="map{{ order.id }}" style="height: 450px; border-radius: 8px; border: 2px solid #ddd;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No orders found.</p>
    {% endif %}
</div>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Include Socket.IO for real-time updates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
<!-- Include Bootstrap 5 JS for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
    .pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    .map-container {
        width: 100%;
        height: 450px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .customer-marker {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #EA4335;
        border: 4px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .driver-marker {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #4285F4;
        border: 4px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        animation: pulse 2s infinite;
    }
    #coordinateInfo {
        font-family: 'Courier New', monospace;
    }
</style>

<script>
const socket = io();

let maps = {};
let driverMarkers = {};
let customerMarkers = {};
let polylines = {};

function updateCoordinateInfo(orderId, customerLat, customerLng, driverLat, driverLng) {
    document.getElementById(`customerCoords${orderId}`).innerHTML = 
        `Your Location: <strong>${customerLat}, ${customerLng}</strong>`;
    document.getElementById(`driverCoords${orderId}`).innerHTML = 
        `Driver Location: <strong>${driverLat || 'Not available'}, ${driverLng || 'Not available'}</strong>`;
}

document.addEventListener('DOMContentLoaded', function() {
    // Track delivery button click - Enhanced with both customer and driver coordinates
    document.querySelectorAll('.track-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const orderId = this.dataset.orderId;
            const customerLat = parseFloat(this.dataset.customerLat);
            const customerLng = parseFloat(this.dataset.customerLng);
            const driverLat = this.dataset.driverLat ? parseFloat(this.dataset.driverLat) : null;
            const driverLng = this.dataset.driverLng ? parseFloat(this.dataset.driverLng) : null;
            const address = this.dataset.address;
            const driverName = this.dataset.driverName;
            const vehicleName = this.dataset.vehicleName;
            const licenseNumber = this.dataset.licenseNumber;
            const status = this.dataset.status;

            console.log('Customer tracking - Your coordinates:', { customerLat, customerLng });
            console.log('Customer tracking - Driver coordinates:', { driverLat, driverLng });

            openTrackingModal(id, orderId, customerLat, customerLng, driverLat, driverLng, address, driverName, vehicleName, licenseNumber, status);
        });
    });

    // Clean up on modal close
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            const orderId = this.id.replace('trackModal', '');
            stopTracking(orderId);
        });
    });

    // Initialize map after modal is shown
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            const orderId = this.id.replace('trackModal', '');
            if (this.id.includes('trackModal') && !maps[orderId]) {
                initCustomerMap(orderId);
            } else if (maps[orderId]) {
                maps[orderId].invalidateSize();
            }
        });
    });
});

function openTrackingModal(id, orderId, customerLat, customerLng, driverLat, driverLng, address, driverName, vehicleName, licenseNumber, status) {
    // Store coordinates globally for this order
    window[`customerLocation${orderId}`] = { lat: customerLat, lng: customerLng };
    window[`driverLocation${orderId}`] = driverLat && driverLng ? { lat: driverLat, lng: driverLng } : null;
    window[`deliveryId${orderId}`] = id;
    window[`deliveryStatus${orderId}`] = status;

    // Update status badge
    document.getElementById(`trackingStatus${orderId}`).textContent = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById(`trackingStatus${orderId}`).className = `badge bg-${
        status === 'pending' ? 'warning' :
        status === 'assigned' ? 'info' :
        status === 'in_transit' ? 'primary' :
        status === 'delivered' ? 'success' :
        status === 'cancelled' ? 'danger' : 'secondary'
    }`;

    // Join SocketIO room for real-time updates
    socket.emit('join', { room: `delivery_${id}` });

    // Listen for real-time driver location updates
    socket.on('location_update', function(data) {
        console.log('Real-time driver location update:', data);
        if (data.id == id && driverMarkers[orderId]) {
            const newLat = data.vehicle_latitude;
            const newLng = data.vehicle_longitude;
            
            // Update driver marker position
            driverMarkers[orderId].setLatLng([newLat, newLng]);
            window[`driverLocation${orderId}`] = { lat: newLat, lng: newLng };
            
            // Redraw route and update distance
            drawRoute(orderId, window[`driverLocation${orderId}`], window[`customerLocation${orderId}`]);
            const distance = calculateDistance(window[`driverLocation${orderId}`], window[`customerLocation${orderId}`]);
            document.getElementById(`distance${orderId}`).textContent = distance.toFixed(2) + ' km';
            
            // Update coordinate display
            updateCoordinateInfo(orderId, customerLat, customerLng, newLat, newLng);
        }
    });

    // Listen for status updates
    socket.on('status_update', function(data) {
        if (data.delivery_id == id) {
            window[`deliveryStatus${orderId}`] = data.status;
            document.getElementById(`trackingStatus${orderId}`).textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            document.getElementById(`trackingStatus${orderId}`).className = `badge bg-${
                data.status === 'pending' ? 'warning' :
                data.status === 'assigned' ? 'info' :
                data.status === 'in_transit' ? 'primary' :
                data.status === 'delivered' ? 'success' :
                data.status === 'cancelled' ? 'danger' : 'secondary'
            }`;
        }
    });
}

function initCustomerMap(orderId) {
    const customerLocation = window[`customerLocation${orderId}`];
    const driverLocation = window[`driverLocation${orderId}`];
    
    console.log('Initializing customer map with locations:', { customerLocation, driverLocation });
    
    // Initialize map centered on customer location (your delivery address)
    maps[orderId] = L.map(`map${orderId}`, {
        zoomControl: true
    }).setView([customerLocation.lat, customerLocation.lng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(maps[orderId]);

    // Customer marker (RED) - Your delivery location
    const customerIcon = L.divIcon({
        className: 'customer-marker',
        iconSize: [35, 35],
        html: '<div style="width:35px;height:35px;border-radius:50%;background:#EA4335;border:4px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;">üè†</div>'
    });

    customerMarkers[orderId] = L.marker([customerLocation.lat, customerLocation.lng], {
        icon: customerIcon
    }).addTo(maps[orderId]);
    customerMarkers[orderId].bindPopup(`
        <div style="text-align: center;">
            <b>üè† Your Delivery Location</b><br>
            <strong>${document.querySelector(`[data-order-id="${orderId}"]`).dataset.address}</strong><br>
            <small>Coordinates: ${customerLocation.lat.toFixed(6)}, ${customerLocation.lng.toFixed(6)}</small>
        </div>
    `);

    // Update coordinate info
    updateCoordinateInfo(orderId, customerLocation.lat, customerLocation.lng, 
                        driverLocation ? driverLocation.lat : null, 
                        driverLocation ? driverLocation.lng : null);

    // Handle driver location
    if (driverLocation) {
        // Use existing driver location
        addDriverMarker(orderId);
        drawRoute(orderId, driverLocation, customerLocation);
        const distance = calculateDistance(driverLocation, customerLocation);
        document.getElementById(`distance${orderId}`).textContent = distance.toFixed(2) + ' km';
        
        // Fit map to show both markers
        maps[orderId].fitBounds([
            [driverLocation.lat, driverLocation.lng],
            [customerLocation.lat, customerLocation.lng]
        ], { padding: [30, 30] });
    } else {
        // Fetch driver location from database
        fetch(`/api/delivery_location/${window[`deliveryId${orderId}`]}`)
            .then(response => response.json())
            .then(data => {
                console.log('Fetched driver location from database:', data);
                
                if (data.vehicle_latitude && data.vehicle_longitude) {
                    window[`driverLocation${orderId}`] = {
                        lat: data.vehicle_latitude,
                        lng: data.vehicle_longitude
                    };
                    
                    addDriverMarker(orderId);
                    drawRoute(orderId, window[`driverLocation${orderId}`], customerLocation);
                    const distance = calculateDistance(window[`driverLocation${orderId}`], customerLocation);
                    document.getElementById(`distance${orderId}`).textContent = distance.toFixed(2) + ' km';
                    updateCoordinateInfo(orderId, customerLocation.lat, customerLocation.lng, 
                                        window[`driverLocation${orderId}`].lat, window[`driverLocation${orderId}`].lng);

                    // Fit map to show both markers
                    maps[orderId].fitBounds([
                        [window[`driverLocation${orderId}`].lat, window[`driverLocation${orderId}`].lng],
                        [customerLocation.lat, customerLocation.lng]
                    ], { padding: [30, 30] });

                    // Update status
                    document.getElementById(`trackingStatus${orderId}`).textContent = data.delivery_status.charAt(0).toUpperCase() + data.delivery_status.slice(1);
                    document.getElementById(`trackingStatus${orderId}`).className = `badge bg-${
                        data.delivery_status === 'pending' ? 'warning' :
                        data.delivery_status === 'assigned' ? 'info' :
                        data.delivery_status === 'in_transit' ? 'primary' :
                        data.delivery_status === 'delivered' ? 'success' :
                        data.delivery_status === 'cancelled' ? 'danger' : 'secondary'
                    }`;
                } else {
                    document.getElementById(`distance${orderId}`).textContent = 'Driver location not available';
                    document.getElementById(`trackingStatus${orderId}`).textContent = 'Driver not started yet';
                    document.getElementById(`trackingStatus${orderId}`).className = 'badge bg-warning';
                    updateCoordinateInfo(orderId, customerLocation.lat, customerLocation.lng, null, null);
                    maps[orderId].setView([customerLocation.lat, customerLocation.lng], 15);
                }
            })
            .catch(error => {
                console.error('Error fetching driver location:', error);
                document.getElementById(`distance${orderId}`).textContent = 'Error loading driver location';
                document.getElementById(`trackingStatus${orderId}`).textContent = 'Error loading tracking';
                document.getElementById(`trackingStatus${orderId}`).className = 'badge bg-danger';
                updateCoordinateInfo(orderId, customerLocation.lat, customerLocation.lng, null, null);
                maps[orderId].setView([customerLocation.lat, customerLocation.lng], 15);
            });
    }
}

function addDriverMarker(orderId) {
    const driverLocation = window[`driverLocation${orderId}`];
    
    if (driverMarkers[orderId]) {
        maps[orderId].removeLayer(driverMarkers[orderId]);
    }
    
    const driverIcon = L.divIcon({
        className: 'driver-marker pulse',
        iconSize: [35, 35],
        html: '<div style="width:35px;height:35px;border-radius:50%;background:#4285F4;border:4px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);animation:pulse 2s infinite;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;">üöó</div>'
    });

    driverMarkers[orderId] = L.marker([driverLocation.lat, driverLocation.lng], {
        icon: driverIcon
    }).addTo(maps[orderId]);
    
    driverMarkers[orderId].bindPopup(`
        <div style="text-align: center;">
            <b>üöó Driver Location</b><br>
            <small>Coordinates: ${driverLocation.lat.toFixed(6)}, ${driverLocation.lng.toFixed(6)}</small>
        </div>
    `);
}

function drawRoute(orderId, start, end) {
    if (polylines[orderId]) {
        maps[orderId].removeLayer(polylines[orderId]);
    }

    polylines[orderId] = L.polyline([
        [start.lat, start.lng],
        [end.lat, end.lng]
    ], {
        color: '#4285F4',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5'
    }).addTo(maps[orderId]);

    // Add route popup with distance
    const distance = calculateDistance(start, end);
    polylines[orderId].bindPopup(`
        <div style="text-align: center;">
            <b>üõ£Ô∏è Delivery Route</b><br>
            Distance: <strong>${distance.toFixed(2)} km</strong>
        </div>
    `);

    // Try to get actual route from OSRM
    getRoute(orderId, start, end);
}

function getRoute(orderId, start, end) {
    const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.code === 'Ok' && data.routes.length > 0) {
                const route = data.routes[0];
                if (polylines[orderId]) {
                    maps[orderId].removeLayer(polylines[orderId]);
                }
                const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                polylines[orderId] = L.polyline(coordinates, {
                    color: '#4285F4',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(maps[orderId]);
                
                const distance = (route.distance / 1000).toFixed(2);
                document.getElementById(`distance${orderId}`).textContent = distance + ' km';
                
                polylines[orderId].bindPopup(`
                    <div style="text-align: center;">
                        <b>üõ£Ô∏è Delivery Route</b><br>
                        Distance: <strong>${distance} km</strong><br>
                        Duration: <strong>${Math.round(route.duration / 60)} min</strong>
                    </div>
                `);
            }
        })
        .catch(error => {
            console.log('Using straight line route:', error);
        });
}

function calculateDistance(point1, point2) {
    const R = 6371; // Earth's radius in km
    const dLat = (point2.lat - point1.lat) * Math.PI / 180;
    const dLon = (point2.lng - point1.lng) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function stopTracking(orderId) {
    const deliveryId = window[`deliveryId${orderId}`];
    if (deliveryId) {
        socket.emit('leave', { room: `delivery_${deliveryId}` });
    }
    
    if (maps[orderId]) {
        maps[orderId].remove();
        delete maps[orderId];
    }
    delete driverMarkers[orderId];
    delete customerMarkers[orderId];
    delete polylines[orderId];
    
    // Clean up global variables
    delete window[`customerLocation${orderId}`];
    delete window[`driverLocation${orderId}`];
    delete window[`deliveryId${orderId}`];
    delete window[`deliveryStatus${orderId}`];
}
</script>
{% endblock %}