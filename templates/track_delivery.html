<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Delivery #{{ delivery.id }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .tracking-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 968px) {
            .tracking-grid {
                grid-template-columns: 1fr;
            }
        }
        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status-pending { background: #ffc107; color: #000; }
        .status-assigned { background: #17a2b8; color: #fff; }
        .status-picked_up { background: #6f42c1; color: #fff; }
        .status-in_transit { background: #007bff; color: #fff; }
        .status-delivered { background: #28a745; color: #fff; }
        .status-cancelled { background: #dc3545; color: #fff; }
        .info-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .info-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .info-item span {
            color: #333;
            font-size: 16px;
        }
        .driver-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .driver-info h3 {
            margin-bottom: 10px;
        }
        .refresh-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .refresh-btn:hover {
            background: #5568d3;
        }
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .legend-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .customer-icon {
            background: #28a745;
            color: white;
        }
        .driver-icon {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-truck"></i> Track Your Delivery</h1>
            <p>Delivery ID: #{{ delivery.id }}</p>
        </div>
    </div>

    <div class="container">
        <div class="tracking-grid">
            <div>
                <div id="map"></div>
            </div>

            <div class="info-panel">
                <h2>Delivery Details</h2>
                <span class="status-badge status-{{ delivery.delivery_status }}" id="statusBadge">
                    {{ delivery.delivery_status.replace('_', ' ').title() }}
                </span>

                <div class="info-item">
                    <strong>Delivery Address</strong>
                    <span>{{ delivery.delivery_address }}</span>
                </div>

                <div class="info-item">
                    <strong>Delivery Type</strong>
                    <span>{{ delivery.delivery_type.title() }}</span>
                </div>

                {% if delivery.estimated_delivery_time %}
                <div class="info-item">
                    <strong>Estimated Delivery Time</strong>
                    <span>{{ delivery.estimated_delivery_time }}</span>
                </div>
                {% endif %}

                {% if delivery.driver %}
                <div class="driver-info" id="driverInfo">
                    <h3><i class="fas fa-user-circle"></i> Driver Information</h3>
                    <p><strong>Name:</strong> <span id="driverName">{{ delivery.driver.name }}</span></p>
                    <p><strong>Vehicle:</strong> <span id="vehicleName">{{ delivery.vehicle_name or 'Not available' }}</span></p>
                    <p><strong>License Plate:</strong> <span id="licensePlate">{{ delivery.license_number or 'Not available' }}</span></p>
                </div>
                {% endif %}

                <div class="legend">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-icon customer-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <span>Your Delivery Address</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon driver-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <span>Driver Location</span>
                    </div>
                </div>

                <button class="refresh-btn" onclick="refreshLocation()">
                    <i class="fas fa-sync-alt"></i> Refresh Location
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize map
        let map;
        let driverMarker;
        let customerMarker;
        let routeLine;

        // Delivery data from server
        const deliveryData = {
            id: '{{ delivery.id }}',
            userLat: '{{ delivery.user_latitude }}',
            userLng: '{{ delivery.user_longitude }}',
            vehicleLat: '{{ delivery.vehicle_latitude }}',
            vehicleLng: '{{ delivery.vehicle_longitude }}',
            status: '{{ delivery.delivery_status }}'
        };

        function initMap() {
            // Default center (will be updated)
            let centerLat = deliveryData.userLat || 5.6037;
            let centerLng = deliveryData.userLng || -0.1870;

            // Initialize map
            map = L.map('map').setView([centerLat, centerLng], 13);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Custom icons
            const customerIcon = L.divIcon({
                html: '<div style="background: #28a745; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-home"></i></div>',
                className: 'custom-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            const driverIcon = L.divIcon({
                html: '<div style="background: #007bff; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-truck"></i></div>',
                className: 'custom-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            // Add customer marker
            if (deliveryData.userLat && deliveryData.userLng) {
                customerMarker = L.marker([deliveryData.userLat, deliveryData.userLng], {
                    icon: customerIcon
                }).addTo(map)
                .bindPopup('<b>Delivery Address</b><br>{{ delivery.delivery_address }}');
            }

            // Add driver marker if available
            if (deliveryData.vehicleLat && deliveryData.vehicleLng) {
                driverMarker = L.marker([deliveryData.vehicleLat, deliveryData.vehicleLng], {
                    icon: driverIcon
                }).addTo(map)
                .bindPopup('<b>Driver Location</b><br>{{ delivery.driver.name if delivery.driver else "Driver" }}');

                // Draw route line between driver and customer
                if (deliveryData.userLat && deliveryData.userLng) {
                    routeLine = L.polyline([
                        [deliveryData.vehicleLat, deliveryData.vehicleLng],
                        [deliveryData.userLat, deliveryData.userLng]
                    ], {
                        color: '#667eea',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);

                    // Fit map to show both markers
                    const bounds = L.latLngBounds([
                        [deliveryData.vehicleLat, deliveryData.vehicleLng],
                        [deliveryData.userLat, deliveryData.userLng]
                    ]);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } else if (deliveryData.userLat && deliveryData.userLng) {
                // If no driver location, center on customer
                map.setView([deliveryData.userLat, deliveryData.userLng], 15);
            }
        }

        function updateDriverLocation(lat, lng, driverName, vehicleName, licensePlate) {
            const driverIcon = L.divIcon({
                html: '<div style="background: #007bff; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-truck"></i></div>',
                className: 'custom-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            if (driverMarker) {
                // Update existing marker
                driverMarker.setLatLng([lat, lng]);
            } else {
                // Create new marker
                driverMarker = L.marker([lat, lng], {
                    icon: driverIcon
                }).addTo(map)
                .bindPopup(`<b>Driver Location</b><br>${driverName || 'Driver'}`);
            }

            // Update route line
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            
            if (deliveryData.userLat && deliveryData.userLng) {
                routeLine = L.polyline([
                    [lat, lng],
                    [deliveryData.userLat, deliveryData.userLng]
                ], {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
            }

            // Update driver info in panel
            if (driverName) {
                document.getElementById('driverName').textContent = driverName;
            }
            if (vehicleName) {
                document.getElementById('vehicleName').textContent = vehicleName;
            }
            if (licensePlate) {
                document.getElementById('licensePlate').textContent = licensePlate;
            }
        }

        function refreshLocation() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

            fetch(`/api/delivery_location/${deliveryData.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        // Update local data
                        deliveryData.vehicleLat = data.vehicle_latitude;
                        deliveryData.vehicleLng = data.vehicle_longitude;
                        deliveryData.status = data.delivery_status;

                        // Update map
                        if (data.vehicle_latitude && data.vehicle_longitude) {
                            updateDriverLocation(
                                data.vehicle_latitude,
                                data.vehicle_longitude,
                                data.driver_name,
                                data.vehicle_name,
                                data.license_number
                            );
                        }

                        // Update status badge
                        document.getElementById('statusBadge').textContent = 
                            data.delivery_status.replace('_', ' ').split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        document.getElementById('statusBadge').className = 
                            `status-badge status-${data.delivery_status}`;
                    }

                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Location';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to refresh location');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Location';
                });
        }

        // Initialize Socket.IO for real-time updates
        const socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to server');
            // Join room for this delivery
            socket.emit('join', `delivery_${deliveryData.id}`);
        });

        // Listen for location updates
        socket.on('location_update', function(data) {
            if (data.delivery_id === deliveryData.id) {
                console.log('Received location update:', data);
                updateDriverLocation(
                    data.vehicle_latitude,
                    data.vehicle_longitude,
                    data.driver_name,
                    data.vehicle_name,
                    data.license_number
                );
            }
        });

        // Listen for status updates
        socket.on('status_update', function(data) {
            if (data.delivery_id === deliveryData.id) {
                console.log('Received status update:', data);
                deliveryData.status = data.status;
                
                // Update status badge
                document.getElementById('statusBadge').textContent = 
                    data.status.replace('_', ' ').split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                document.getElementById('statusBadge').className = 
                    `status-badge status-${data.status}`;

                // Show notification
                if (data.status === 'delivered') {
                    alert('Your delivery has been completed! ðŸŽ‰');
                }
            }
        });

        // Initialize map on page load
        window.addEventListener('load', initMap);
    </script>
</body>
</html>