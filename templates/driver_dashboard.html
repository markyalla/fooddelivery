{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Driver Dashboard - {{ user.name }}</h2>
    
    <div class="driver-info mb-4">
        <h4>Your Details:</h4>
        <p><strong>Vehicle:</strong> {{ user.vehicle_name|default('N/A') }}</p>
        <p><strong>License Number:</strong> {{ user.license_number|default('N/A') }}</p>
    </div>

    <h4>Assigned Deliveries:</h4>
    {% if deliveries %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Delivery Address</th>
                    <th>Status</th>
                    <th>Estimated Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for delivery in deliveries %}
                <tr>
                    <td>{{ delivery.order_id }}</td>
                    <td>{{ delivery.delivery_address|default('N/A') }}</td>
                    <td>
                        <span class="badge bg-{% if delivery.delivery_status|lower == 'pending' %}warning{% elif delivery.delivery_status|lower == 'in_transit' %}primary{% elif delivery.delivery_status|lower == 'delivered' %}success{% elif delivery.delivery_status|lower == 'cancelled' %}danger{% else %}secondary{% endif %}">
                            {{ delivery.delivery_status|title }}
                        </span>
                    </td>
                    <td>{{ delivery.estimated_delivery_time|default('Not specified') }}</td>
                    <td>
                        {% if delivery.delivery_status|lower == 'assigned' %}
                            <button class="btn btn-sm btn-success start-tracking-btn" 
                                    data-id="{{ delivery.id }}">
                                <i class="fas fa-play"></i> Start Tracking
                            </button>
                        {% elif delivery.delivery_status|lower == 'in_transit' %}
                            {% if delivery.user_latitude and delivery.user_longitude %}
                                <button class="btn btn-sm btn-primary track-btn" 
                                        data-id="{{ delivery.id }}"
                                        data-order-id="{{ delivery.order_id }}"
                                        data-lat="{{ delivery.user_latitude }}"
                                        data-lng="{{ delivery.user_longitude }}"
                                        data-address="{{ delivery.delivery_address|default('N/A') }}"
                                        data-driver-name="{{ delivery.driver_name|default('N/A') }}"
                                        data-vehicle-name="{{ delivery.vehicle_name|default('N/A') }}"
                                        data-license-number="{{ delivery.license_number|default('N/A') }}"
                                        data-customer-name="{{ delivery.order.user.name|default('N/A') }}"
                                        data-customer-phone="{{ delivery.order.user.phone|default('N/A') }}"
                                        data-status="{{ delivery.delivery_status|lower }}"
                                        data-vehicle-lat="{{ delivery.vehicle_latitude|default('') }}"
                                        data-vehicle-lng="{{ delivery.vehicle_longitude|default('') }}">
                                    <i class="fas fa-map-marker-alt"></i> Track Delivery
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-warning" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> No Location
                                </button>
                            {% endif %}
                        {% else %}
                            <span class="text-{% if delivery.delivery_status|lower == 'delivered' %}success{% else %}danger{% endif %}">
                                {{ delivery.delivery_status|title }}
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="alert alert-info">No deliveries assigned to you yet.</div>
    {% endif %}
</div>

<!-- Single Tracking Modal -->
<div class="modal fade" id="trackingModal" tabindex="-1" aria-labelledby="trackingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trackingModalLabel">Tracking Order #<span id="modalOrderId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <p><strong>Customer Name:</strong> <span id="customerName"></span></p>
                        <p><strong>Customer Phone:</strong> <span id="customerPhone"></span></p>
                        <p><strong>Delivery Address:</strong> <span id="deliveryAddress"></span></p>
                        <p><strong>Distance:</strong> <span id="distance">Calculating...</span></p>
                        <p><strong>Status:</strong> <span id="trackingStatus" class="badge bg-info">Ready to start</span></p>
                        <div id="coordinateDebug" style="font-size: 12px; color: #666; margin-top: 10px;"></div>
                    </div>
                </div>
                <div id="map" style="height: 450px; width: 100%; border-radius: 8px; border: 2px solid #ddd;"></div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button class="btn btn-success" id="startDeliveryBtn" style="display:none;">
                        <i class="fas fa-play"></i> Start Delivery
                    </button>
                    <button class="btn btn-primary" id="updateLocationBtn" style="display:none;">
                        <i class="fas fa-location-arrow"></i> Update My Location
                    </button>
                    <button class="btn btn-danger" id="completeDeliveryBtn" style="display:none;">
                        <i class="fas fa-check"></i> Mark as Delivered
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Include Socket.IO for real-time updates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
<!-- Include Bootstrap 5 JS for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
.track-btn { white-space: nowrap; }
.leaflet-container { font-family: inherit; }
.driver-marker { 
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    background-color: #4285F4; 
    border: 4px solid white; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
    animation: pulse 2s infinite; 
}
.customer-marker { 
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    background-color: #EA4335; 
    border: 4px solid white; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
}
@keyframes pulse { 
    0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7); } 
    70% { box-shadow: 0 0 0 15px rgba(66, 133, 244, 0); } 
    100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); } 
}
.btn:disabled { cursor: not-allowed; }
.mt-3.d-flex { gap: 8px; }
@media (max-width: 576px) { 
    .mt-3.d-flex { flex-direction: column; } 
    .mt-3.d-flex button { width: 100%; } 
}
</style>

<script>
const socket = io();

let map, driverMarker, customerMarker, routeLine, watchId, currentDeliveryId, customerLocation, driverLocation, trackingInterval, currentDeliveryStatus;

function debugCoordinates(customerLat, customerLng, driverLat, driverLng) {
    const debugDiv = document.getElementById('coordinateDebug');
    debugDiv.innerHTML = `
        <strong>Debug Info:</strong><br>
        Customer: ${customerLat}, ${customerLng}<br>
        Driver: ${driverLat || 'N/A'}, ${driverLng || 'N/A'}
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    // Start Tracking Button
    document.querySelectorAll('.start-tracking-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            getCurrentLocation(id);
        });
    });

    // Track Delivery Button - Enhanced with vehicle coordinates
    document.querySelectorAll('.track-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const orderId = this.dataset.orderId;
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            const address = this.dataset.address;
            const customerName = this.dataset.customerName;
            const customerPhone = this.dataset.customerPhone;
            const status = this.dataset.status;
            const vehicleLat = this.dataset.vehicleLat ? parseFloat(this.dataset.vehicleLat) : null;
            const vehicleLng = this.dataset.vehicleLng ? parseFloat(this.dataset.vehicleLng) : null;

            openTrackingModal(id, orderId, lat, lng, address, customerName, customerPhone, status, vehicleLat, vehicleLng);
        });
    });

    // Modal buttons
    document.getElementById('startDeliveryBtn').addEventListener('click', startDelivery);
    document.getElementById('updateLocationBtn').addEventListener('click', updateDriverLocation);
    document.getElementById('completeDeliveryBtn').addEventListener('click', completeDelivery);
    document.getElementById('trackingModal').addEventListener('hidden.bs.modal', stopTracking);

    // Socket listeners
    socket.on('location_update', function(data) {
        console.log('Location update received:', data);
        if (data.id == currentDeliveryId && driverMarker) {
            const newLat = data.vehicle_latitude;
            const newLng = data.vehicle_longitude;
            
            driverMarker.setLatLng([newLat, newLng]);
            driverLocation = { lat: newLat, lng: newLng };
            drawRoute(driverLocation, customerLocation);
            document.getElementById('distance').textContent = calculateDistance(driverLocation, customerLocation).toFixed(2) + ' km';
            debugCoordinates(customerLocation.lat, customerLocation.lng, newLat, newLng);
        }
    });
});

function openTrackingModal(id, orderId, lat, lng, address, customerName, customerPhone, status, vehicleLat, vehicleLng) {
    currentDeliveryId = id;
    
    // Set customer location
    customerLocation = { lat, lng };
    
    // Set driver location if available
    if (vehicleLat && vehicleLng) {
        driverLocation = { lat: vehicleLat, lng: vehicleLng };
    }
    
    currentDeliveryStatus = status;

    // Update modal content
    document.getElementById('modalOrderId').textContent = orderId;
    document.getElementById('customerName').textContent = customerName;
    document.getElementById('customerPhone').textContent = customerPhone;
    document.getElementById('deliveryAddress').textContent = address;
    document.getElementById('trackingStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById('trackingStatus').className = `badge bg-${status === 'in_transit' ? 'primary' : 'info'}`;

    updateButtonVisibility();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('trackingModal'));
    modal.show();

    // Join room
    socket.emit('join', { room: `delivery_${id}` });

    // Initialize map after modal shows
    document.getElementById('trackingModal').addEventListener('shown.bs.modal', function() {
        initMap();
        
        // If delivery is in transit, start automatic location updates
        if (currentDeliveryStatus === 'in_transit') {
            startAutoLocationUpdates();
        }
    }, { once: true });
}

function initMap() {
    console.log('Initializing map with customer location:', customerLocation);
    
    // Clear existing map
    if (map) map.remove();
    
    // Initialize map centered on customer location
    map = L.map('map').setView([customerLocation.lat, customerLocation.lng], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Customer marker (RED)
    const customerIcon = L.divIcon({
        className: 'customer-marker',
        iconSize: [30, 30],
        html: '<div style="width:30px;height:30px;border-radius:50%;background:#EA4335;border:4px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>'
    });
    customerMarker = L.marker([customerLocation.lat, customerLocation.lng], { icon: customerIcon })
        .addTo(map)
        .bindPopup('<b>üìç Customer Location</b><br>' + document.getElementById('deliveryAddress').textContent);

    // Handle driver location
    if (driverLocation) {
        // Use existing driver location
        addDriverMarker();
        drawRoute(driverLocation, customerLocation);
        const distance = calculateDistance(driverLocation, customerLocation);
        document.getElementById('distance').textContent = distance.toFixed(2) + ' km';
        debugCoordinates(customerLocation.lat, customerLocation.lng, driverLocation.lat, driverLocation.lng);
        
        // Fit map to show both markers
        map.fitBounds([
            [driverLocation.lat, driverLocation.lng],
            [customerLocation.lat, customerLocation.lng]
        ], { padding: [20, 20] });
    } else {
        // Fetch driver location from database
        fetch(`/api/delivery_location/${currentDeliveryId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Fetched delivery location:', data);
                
                if (data.vehicle_latitude && data.vehicle_longitude) {
                    
                    driverLocation = { lat: data.vehicle_latitude, lng: data.vehicle_longitude };
                    addDriverMarker();
                    drawRoute(driverLocation, customerLocation);
                    const distance = calculateDistance(driverLocation, customerLocation);
                    document.getElementById('distance').textContent = distance.toFixed(2) + ' km';
                    debugCoordinates(customerLocation.lat, customerLocation.lng, driverLocation.lat, driverLocation.lng);

                    // Fit map to show both markers
                    map.fitBounds([
                        [driverLocation.lat, driverLocation.lng],
                        [customerLocation.lat, customerLocation.lng]
                    ], { padding: [20, 20] });
                } else {
                    // Get current location as fallback
                    navigator.geolocation.getCurrentPosition(pos => {
                        const currentLat = pos.coords.latitude;
                        const currentLng = pos.coords.longitude;
                        
                        driverLocation = { lat: currentLat, lng: currentLng };
                        addDriverMarker();
                        drawRoute(driverLocation, customerLocation);
                        document.getElementById('distance').textContent = calculateDistance(driverLocation, customerLocation).toFixed(2) + ' km';
                        debugCoordinates(customerLocation.lat, customerLocation.lng, currentLat, currentLng);
                    }, error => {
                        console.error('Geolocation error:', error);
                        document.getElementById('distance').textContent = 'Location unavailable';
                        debugCoordinates(customerLocation.lat, customerLocation.lng, null, null);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching delivery location:', error);
                document.getElementById('distance').textContent = 'Error loading location';
                debugCoordinates(customerLocation.lat, customerLocation.lng, null, null);
            });
    }
}

function addDriverMarker() {
    if (driverMarker) map.removeLayer(driverMarker);
    
    const driverIcon = L.divIcon({
        className: 'driver-marker',
        iconSize: [30, 30],
        html: '<div style="width:30px;height:30px;border-radius:50%;background:#4285F4;border:4px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);animation:pulse 2s infinite;"></div>'
    });
    driverMarker = L.marker([driverLocation.lat, driverLocation.lng], { icon: driverIcon })
        .addTo(map)
        .bindPopup('<b>üöó Your Location</b>');
}

function drawRoute(start, end) {
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
        color: '#4285F4', 
        weight: 4, 
        opacity: 0.7,
        dashArray: '10, 5'
    }).addTo(map);
}

function calculateDistance(p1, p2) {
    const R = 6371; // Earth's radius in km
    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
    const dLon = (p2.lng - p1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
              Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * 
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function updateButtonVisibility() {
    document.getElementById('startDeliveryBtn').style.display = currentDeliveryStatus === 'assigned' ? 'inline-block' : 'none';
    document.getElementById('updateLocationBtn').style.display = currentDeliveryStatus === 'in_transit' ? 'inline-block' : 'none';
    document.getElementById('completeDeliveryBtn').style.display = currentDeliveryStatus === 'in_transit' ? 'inline-block' : 'none';
}

function getCurrentLocation(id) {
    // Show loading state
    const btn = document.querySelector(`[data-id="${id}"]`);
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
        pos => {
            console.log('Got location:', pos.coords.latitude, pos.coords.longitude);
            startTracking(id, pos);
        }, 
        (error) => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error('Geolocation error:', error);
            alert('Please enable location access to start tracking. Error: ' + error.message);
        }, 
        { 
            enableHighAccuracy: true, 
            timeout: 15000,
            maximumAge: 0  // Don't use cached position
        }
    );
}

function startTracking(id, position) {
    console.log('üöó Starting tracking with coordinates:', position.coords.latitude, position.coords.longitude);
    
    fetch(`/driver/start_tracking/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            latitude: position.coords.latitude, 
            longitude: position.coords.longitude 
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Server returned ' + r.status);
        }
        return r.json();
    })
    .then(data => {
        console.log('‚úÖ SAVED TO DB:', data);  // ‚úÖ NEW: Full debug
        console.log('üîµ DRIVER:', data.vehicle_lat, data.vehicle_lng);  // ‚úÖ NEW: Coordinates
        alert('‚úÖ Vehicle location saved! Status: ' + data.status);
        location.reload();
    })
    .catch(error => {
        console.error('‚ùå ERROR:', error);
        alert('‚ùå Error starting tracking: ' + error.message);
    });
}

function startDelivery() {
    if (currentDeliveryId) {
        fetch(`/driver/update_delivery_status/${currentDeliveryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'status=in_transit'
        })
        .then(response => {
            if (response.ok) {
                alert('‚úÖ Delivery started!');
                currentDeliveryStatus = 'in_transit';
                updateButtonVisibility();
                
                // Start automatic location updates every 10 seconds
                startAutoLocationUpdates();
                
                location.reload();
            }
        });
    }
}

function startAutoLocationUpdates() {
    // Clear any existing interval
    if (trackingInterval) {
        clearInterval(trackingInterval);
    }
    
    // Update location every 10 seconds
    trackingInterval = setInterval(() => {
        if (currentDeliveryStatus === 'in_transit') {
            navigator.geolocation.getCurrentPosition(pos => {
                fetch('/driver/update_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        delivery_id: currentDeliveryId,
                        latitude: pos.coords.latitude, 
                        longitude: pos.coords.longitude 
                    })
                })
                .then(r => r.json())
                .then(data => {
                    console.log('Auto location update successful');
                    // Update local driver location
                    driverLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if (driverMarker) {
                        driverMarker.setLatLng([driverLocation.lat, driverLocation.lng]);
                        drawRoute(driverLocation, customerLocation);
                        document.getElementById('distance').textContent = calculateDistance(driverLocation, customerLocation).toFixed(2) + ' km';
                        debugCoordinates(customerLocation.lat, customerLocation.lng, driverLocation.lat, driverLocation.lng);
                    }
                })
                .catch(err => console.error('Auto update failed:', err));
            }, null, { enableHighAccuracy: true, maximumAge: 0 });
        } else {
            // Stop auto updates if delivery is no longer in transit
            clearInterval(trackingInterval);
        }
    }, 10000); // Update every 10 seconds
}

function updateDriverLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        fetch('/driver/update_location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                delivery_id: currentDeliveryId,
                latitude: pos.coords.latitude, 
                longitude: pos.coords.longitude 
            })
        })
        .then(r => r.json())
        .then(data => {
            alert('‚úÖ Location updated!');
            // Update local driver location
            driverLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if (driverMarker) {
                driverMarker.setLatLng([driverLocation.lat, driverLocation.lng]);
                drawRoute(driverLocation, customerLocation);
                document.getElementById('distance').textContent = calculateDistance(driverLocation, customerLocation).toFixed(2) + ' km';
                debugCoordinates(customerLocation.lat, customerLocation.lng, driverLocation.lat, driverLocation.lng);
            }
        })
        .catch(err => {
            console.error('Error updating location:', err);
            alert('‚ùå Error updating location');
        });
    }, null, { enableHighAccuracy: true, maximumAge: 0 });
}

function completeDelivery() {
    if (confirm('Mark this delivery as completed?')) {
        fetch(`/driver/update_delivery_status/${currentDeliveryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'status=delivered'
        })
        .then(response => {
            if (response.ok) {
                alert('‚úÖ Delivery completed!');
                location.reload();
            }
        });
    }
}

function stopTracking() { 
    if (watchId) navigator.geolocation.clearWatch(watchId);
    if (trackingInterval) clearInterval(trackingInterval);
    if (map) map.remove();
    if (currentDeliveryId) {
        socket.emit('leave', { room: `delivery_${currentDeliveryId}` });
    }
}
</script>
{% endblock %}